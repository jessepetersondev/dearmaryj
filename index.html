<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dear Mary J â€” Private Cannabis Journal with One Puff Rating (0.0â€“10.0)</title>
  <meta name="description" content="Dear Mary J is A private cannabis journal. Track products, remember favorites, and rate them with the One Puff Rating (0.0â€“10.0). One-time unlock: $4.20." />
  <link rel="canonical" href="https://dearmaryj.com/" />

  <!-- Open Graph -->
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Dear Mary J" />
  <meta property="og:title" content="Dear Mary J â€” Private Cannabis Journal (One Puff Rating)" />
  <meta property="og:description" content="Track products, remember what you loved, and rate with the One Puff Rating (0.0â€“10.0). Private & local-first. One-time unlock: $4.20." />
  <meta property="og:url" content="https://dearmaryj.com/" />
  <meta property="og:image" content="https://dearmaryj.com/social/og-1200x630.png" />

  <!-- Twitter -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Dear Mary J â€” Private Cannabis Journal" />
  <meta name="twitter:description" content="A private cannabis journal with the One Puff Rating (0.0â€“10.0). One-time unlock: $4.20." />
  <meta name="twitter:image" content="https://dearmaryj.com/social/twitter-1500x500.png" />

  <!-- PWA / Icons -->
  <link rel="icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#2BD576">

  <!-- Font & Bootstrap -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" crossorigin="anonymous">

  <!-- Brand tokens (optional) -->
  <link rel="stylesheet" href="brand/brand.css">
  <link rel="icon" href="/icons/favicon.ico">
  <link rel="apple-touch-icon" href="/icons/icon-180.png">
  <link rel="manifest" href="/site.webmanifest">
  <meta name="theme-color" content="#2BD576">
  <meta property="og:image" content="https://dearmaryj.com/social/og-1200x630.png">
  <meta name="twitter:image" content="https://dearmaryj.com/social/twitter-1500x500.png">

  <style>
    :root{
      --bg: #0b0f0d;
      --panel: #101613;
      --panel-2: #0f140f;
      --text: #e7f3ec;
      --muted: #a6b7af;
      --accent: #2bd576;
      --accent-600:#1fb562;
      --accent-700:#139a53;
      --stroke: #1b241f;
      --shadow: 0 10px 30px rgba(0,0,0,.35), 0 6px 16px rgba(23, 46, 33, .25);
      --radius: 16px;
      --radius-sm: 12px;
    }

    html, body {
      height: 100%;
      background:
        radial-gradient(1200px 1200px at -10% -10%, rgba(43,213,118,.12), transparent 60%),
        radial-gradient(1000px 1000px at 110% 0%, rgba(43,213,118,.10), transparent 55%),
        radial-gradient(1000px 1000px at 50% 120%, rgba(43,213,118,.08), transparent 60%),
        var(--bg);
      color: var(--text);
      font-family: "Inter", system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    .app-shell { max-width: 1100px; margin: 56px auto; padding: 0 20px; }

    /* BRAND HEADER */
    .brandbar {
      display: flex; align-items: center; justify-content: space-between; gap: 16px;
      padding: 14px 18px;
      border: 1px solid var(--stroke);
      border-radius: calc(var(--radius) + 6px);
      background: linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .brandbar .brand-left { display: flex; align-items: center; gap: 16px; min-width: 0; }
    .brand-logo { display: block; height: 100px; width: auto; border-radius: 10px; }
    .brand-title { display: flex; flex-direction: column; min-width: 0; }
    .brand-title .name { font-weight: 800; letter-spacing: -0.02em; font-size: 22px; line-height: 1.1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .brand-title .domain { color: var(--muted); font-weight: 600; font-size: 13px; }
    .brand-tag {
      display: inline-flex; align-items: center; gap:8px;
      background: rgba(43,213,118,.10);
      border: 1px solid rgba(43,213,118,.35);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600; font-size: 12px; line-height: 1;
      white-space: nowrap;
    }

    .hero {
      background:
        linear-gradient(135deg, rgba(43,213,118,.18), rgba(43,213,118,0) 60%),
        linear-gradient(0deg, rgba(255,255,255,.02), rgba(255,255,255,0));
      border: 1px solid var(--stroke);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      padding: 24px 24px 18px;
      backdrop-filter: blur(6px);
    }
    .hero h1{
      letter-spacing: -0.02em;
      font-weight: 800;
      font-size: clamp(26px, 4vw, 38px);
      margin: 0 0 6px;
      display: flex; align-items: center; gap:12px;
    }
    .hero-badge {
      display: inline-flex; align-items: center; gap:8px;
      background: rgba(43,213,118,.10);
      border: 1px solid rgba(43,213,118,.35);
      color: var(--accent);
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 600;
      font-size: 12px;
      line-height: 1;
    }
    .subtle { color: var(--muted); margin: 10px 0 0; }

    .panel { background: linear-gradient(180deg, var(--panel), var(--panel-2)); border: 1px solid var(--stroke); border-radius: var(--radius); box-shadow: var(--shadow); }
    .panel-header { padding: 18px 20px 14px; border-bottom: 1px solid var(--stroke); display: flex; align-items: center; justify-content: space-between; gap:12px; flex-wrap: wrap; }
    .panel-header h4{ margin: 0; font-weight: 700; letter-spacing: -0.01em; }
    .panel-body { padding: 18px 20px; }

    /* Inputs */
    .form-label { color: var(--muted); font-weight: 600; }
    .form-control, .form-select, textarea.form-control {
      background: #0f1411; border: 1px solid #1b241f; color: var(--text);
      border-radius: 12px; transition: border-color .2s, box-shadow .2s, background .2s;
    }
    .form-control:focus, .form-select:focus, textarea.form-control:focus {
      border-color: rgba(43,213,118,.6); box-shadow: 0 0 0 4px rgba(43,213,118,.15);
      background: #0e1310; color: var(--text);
    }

    /* Buttons */
    .btn-success{
      background: linear-gradient(180deg, var(--accent), var(--accent-600));
      border: 1px solid var(--accent-700);
      border-radius: 12px; font-weight: 700; letter-spacing: .01em;
      padding: 10px 16px; box-shadow: 0 8px 20px rgba(43,213,118,.25);
    }
    .btn-success:hover{ filter: brightness(1.05); }
    .btn-outline-secondary{ color: var(--muted); border-color: #253029; }
    .btn-outline-secondary:hover{ background: #152019; color: var(--text); border-color: #253029; }
    .btn-outline-danger{ border-color: #3a2426; color: #ffb4bd; }
    .btn-outline-danger:hover{ background: #2a1719; border-color:#3a2426; color: #ffd7dc; }

    /* Slider (exact fill) */
    .slider {
      -webkit-appearance: none; appearance: none; width: 100%; height: 10px; border-radius: 999px;
      outline: none; border: 1px solid #1b241f; background-color: #1e2622;
      background-image: linear-gradient(90deg, var(--accent), var(--accent));
      background-repeat: no-repeat; background-size: 0% 100%;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none; appearance: none; width: 22px; height: 22px;
      background: radial-gradient(circle at 30% 30%, #eafff3 0 12%, transparent 13%), linear-gradient(180deg, #ffffff, #c7ffd9);
      border-radius: 50%; border: 2px solid var(--accent-700); cursor: pointer;
      box-shadow: 0 6px 14px rgba(43,213,118,.35), inset 0 0 0 2px rgba(255,255,255,.7);
    }
    .slider::-moz-range-thumb {
      width: 22px; height: 22px; background: radial-gradient(circle at 30% 30%, #eafff3 0 12%, transparent 13%), linear-gradient(180deg, #ffffff, #c7ffd9);
      border-radius: 50%; border: 2px solid var(--accent-700); cursor: pointer;
      box-shadow: 0 6px 14px rgba(43,213,118,.35), inset 0 0 0 2px rgba(255,255,255,.7);
    }
    .form-text { color: var(--muted); }

    /* Leaf rating bar */
    .leaf-rating { position: relative; display: inline-block; width: 240px; height: 24px;
      background: url('assets/leaf-gray.svg') repeat-x; background-size: 24px 24px;
      vertical-align: middle; margin-right: .5rem; filter: drop-shadow(0 1px 0 rgba(0,0,0,.35)); }
    .leaf-rating-full { position: absolute; top: 0; left: 0; height: 24px;
      background: url('assets/leaf-green.svg') repeat-x; background-size: 24px 24px; }
    .mono { font-variant-numeric: tabular-nums; color: var(--muted); font-weight: 700; }

    /* Table */
    .table { --bs-table-bg: transparent; --bs-table-color: var(--text); --bs-table-border-color: var(--stroke); }
    thead.table-light { color: var(--text); background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)); border-bottom: 1px solid var(--stroke); user-select: none; }
    .sortable { cursor: pointer; position: relative; }
    .sortable .sort-indicator{ opacity:.65; margin-left:.35rem; font-size:.9em; }
    .table tbody tr{ transition: background .15s ease, transform .05s ease; }
    .table tbody tr:hover{ background: rgba(43,213,118,.05); }
    .table td, .table th{ border-color: var(--stroke) !important; }

    /* Search box */
    .search-wrap { width: 320px; max-width: 100%; }
    .search-wrap .form-control { padding-left: 40px; }
    .search-icon { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--muted); pointer-events: none; }

    /* Footer */
    .site-footer { margin-top: 18px; color: var(--muted); font-size: 13px; text-align: center; }

    /* --- PAYWALL overlay (additive, covers app until unlocked) --- */
    #dmjPaywallOverlay {
      position: fixed; inset: 0; z-index: 2147483647; display: none;
      background:
        radial-gradient(1200px 1200px at -10% -10%, rgba(43,213,118,.12), transparent 60%),
        radial-gradient(1000px 1000px at 110% 0%, rgba(43,213,118,.10), transparent 55%),
        radial-gradient(1000px 1000px at 50% 120%, rgba(43,213,118,.08), transparent 60%),
        var(--bg);
      color: var(--text); backdrop-filter: blur(6px);
      overflow-y: auto;
    }
    #dmjPaywallCard {
      max-width: 1040px; margin: 6vh auto; padding: 34px 34px 28px;
      border-radius: 18px; border: 1px solid var(--stroke);
      background: linear-gradient(180deg, var(--panel), var(--panel-2));
      box-shadow: var(--shadow);
    }

    /* Re-order to place IMAGE FIRST on desktop, then content */
    .dmj-grid {
      display: grid;
      grid-template-columns: .95fr 1.05fr;            /* image a touch larger */
      grid-template-areas: "image content";
      gap: 28px;
      align-items: start;
    }
    .dmj-grid > div:first-child { grid-area: content; }
    .dmj-grid > div:last-child  { grid-area: image; }

    .dmj-title { font-weight: 800; letter-spacing: -0.02em; font-size: clamp(24px, 3.2vw, 40px); margin: 0 0 6px; }
    .dmj-sub { color: var(--muted); margin: 8px 0 0; line-height: 1.6; font-size: 15.5px; }
    .dmj-flex { display: flex; align-items: center; gap: 14px; margin-bottom: 8px; }

    .dmj-points { margin: 14px 0 0; padding-left: 22px; }
    .dmj-points li { margin: 6px 0; color: var(--muted); line-height: 1.55; }

    .dmj-actions {
      display: flex; gap: 12px; flex-wrap: wrap; margin-top: 16px;
    }
    .dmj-btn {
      display: inline-block; padding: 12px 18px; border-radius: 14px; font-weight: 800; letter-spacing: .01em; text-decoration: none;
      border: 1px solid var(--accent-700); background: linear-gradient(180deg, var(--accent), var(--accent-600)); color: #05140c;
      box-shadow: 0 10px 24px rgba(43,213,118,.28);
    }
    .dmj-btn:hover { filter: brightness(1.05); }
    .dmj-ghost-btn {
      display: inline-block; padding: 12px 18px; border-radius: 14px; text-decoration: none; color: var(--text);
      border: 1px solid #253029; background: #0f1411;
      font-weight: 700;
    }
    .dmj-ghost-btn:hover { background:#152019; color: var(--text); }
    .dmj-price { font-weight: 800; color: var(--accent); }

    .dmj-screenshot {
      display: block;
      border-radius: 16px; border: 1px solid var(--stroke);
      background: #0d1411; box-shadow: var(--shadow); width: 100%;
      max-height: 520px; object-fit: cover; object-position: top center;
    }
    .dmj-note { color: var(--muted); font-size: 13px; margin-top: 10px; text-align: center; }

    .dmj-spinner { width: 26px; height: 26px; border: 3px solid rgba(255,255,255,.25); border-top-color: var(--accent); border-radius: 50%; animation: dmjspin 1s linear infinite; }
    @keyframes dmjspin { to { transform: rotate(360deg); } }

    /* On smaller screens, keep image FIRST and then content; widen spacing */
    @media (max-width: 900px){
      #dmjPaywallCard { margin: 4vh auto; padding: 26px 20px 22px; }
      .dmj-grid {
        grid-template-columns: 1fr;
        grid-template-areas:
          "image"
          "content";
        gap: 18px;
      }
      .dmj-title { font-size: clamp(22px, 5.5vw, 30px); }
      .dmj-sub { font-size: 15px; }
      .dmj-screenshot { max-height: none; }
      .dmj-actions { gap: 10px; }
      .dmj-btn, .dmj-ghost-btn { width: 100%; text-align: center; }
    }
    /* --- END updated PAYWALL styles --- */

    @media (max-width: 768px){
      .leaf-rating { width: 180px; height: 18px; background-size: 18px 18px; }
      .leaf-rating-full { height: 18px; background-size: 18px 18px; }
      .brand-logo { height: 40px; }
    }

    /* Mobile: card view for entries table (â‰¤640px) */
    @media (max-width: 640px){
      .table-responsive{overflow: visible;}
      #entriesTable thead{display:none;}
      #entriesTable, #entriesTable tbody, #entriesTable tr, #entriesTable td{display:block;width:100%;}
      #entriesTable tr{
        background: linear-gradient(180deg, var(--panel), var(--panel-2));
        border:1px solid var(--stroke);
        border-radius:12px;
        padding:8px 10px;
        margin-bottom:10px;
      }
      #entriesTable td{border:none !important; padding:8px 10px;}
      #entriesTable td[data-label]::before{
        content:attr(data-label);
        display:block; font-weight:600; color:var(--muted); margin-bottom:4px;
      }
      #entriesTable td:last-child{display:flex; gap:8px; justify-content:flex-end; padding-top:6px;}
      .search-wrap{width:100%;}
    }

    /* --- Grouping styles (new) --- */
    .group-controls { display:flex; align-items:center; gap:8px; }
    .group-select { min-width: 160px; }
    .group-btn { padding:6px 10px; border-radius:10px; border:1px solid #253029; background:#0f1411; color:var(--text); font-weight:600; }
    .group-btn:hover { background:#152019; }

    .group-row {
      background: rgba(43,213,118,.08);
      border: 1px solid var(--stroke);
      border-left: 3px solid var(--accent);
      cursor: pointer;
    }
    .group-row:hover { background: rgba(43,213,118,.12); }
    .group-cell {
      font-weight: 700;
      color: var(--text);
    }
    .group-meta {
      color: var(--muted);
      font-weight: 600;
      font-size: 12px;
      margin-left: 8px;
    }
    .collapse-indicator {
      font-weight: 800;
      margin-right: 8px;
      color: var(--accent);
    }

    /* Mobile: group row looks like a card header */
    @media (max-width: 640px){
      .group-row {
        border-radius: 12px;
        padding: 10px !important;
        margin-bottom: 8px;
      }
      .group-cell { display: flex; align-items: center; justify-content: space-between; }
    }
  </style>
</head>
<body>
  <div class="app-shell">

    <!-- PAYWALL OVERLAY -->
    <div id="dmjPaywallOverlay" role="dialog" aria-modal="true" aria-label="Unlock Dear Mary J">
      <div id="dmjPaywallCard">
        <div class="dmj-grid">
          <div>
            <div class="dmj-flex">
              <img src="logos/logo-square.svg" alt="Dear Mary J" style="height:56px;width:56px;border-radius:12px;border:1px solid var(--stroke);background:var(--panel);padding:6px" onerror="this.style.display='none'">
              <div>
                <h2 class="dmj-title">Unlock Dear Mary J</h2>
                <p class="dmj-sub">A private cannabis journal. Track products and rate them with the <strong>One Puff Rating</strong> (0.0â€“10.0).</p>
              </div>
            </div>

            <div class="dmj-actions" style="margin-top:16px">
              <a class="dmj-btn" id="dmjUnlockBtn" href="#">Unlock Full Access â€” $4.20</a>
              <a class="dmj-ghost-btn" id="dmjShowRestore" href="javascript:void(0)">Restore Purchase</a>
              <span id="dmjPaywallSpinner" class="dmj-spinner" style="display:none"></span>
            </div>

            <div id="dmjRestoreWrap" style="display:none;margin-top:12px">
              <label for="dmjRestoreEmail" class="dmj-sub" style="display:block;margin-bottom:6px">Enter your purchase email</label>
              <div style="display:flex;gap:8px;flex-wrap:wrap">
                <input id="dmjRestoreEmail" type="email" placeholder="you@example.com" style="flex:1;min-width:240px;padding:10px 12px;border-radius:12px;border:1px solid #1b241f;background:#0f1411;color:var(--text)">
                <button id="dmjDoRestore" class="dmj-btn" type="button">Restore</button>
              </div>
              <div id="dmjRestoreMsg" class="dmj-note" style="margin-top:8px"></div>
            </div>

          </div>

          <div>
            <img class="dmj-screenshot" src="assets/paywall-overlay-preview.jpg" alt="Dear Mary J app preview" onerror="this.style.display='none'">
          </div>
        </div>
      </div>
    </div>

    <!-- HERO -->
    <section class="hero mb-4">
      <div class="d-flex flex-wrap align-items-center justify-content-between gap:3">
        <div class="brand-left">
          <img class="brand-logo" src="logos/logo-horizontal.svg" alt="Dear Mary J logo" onerror="this.src='logos/logo-horizontal.png'; this.onerror=null;">
        </div>
        <div>
          <h1><span class="hero-badge" aria-hidden="true">JOURNAL</span></h1>
          <p class="subtle">Track products & rate them with the <strong>One Puff Rating</strong> <span class="text-success">(0.0â€“10.0)</span>.</p>
        </div>
      </div>
    </section>

    <!-- FORM PANEL -->
    <section class="panel mb-4">
      <div class="panel-header">
        <h4>Add a New Entry</h4>
      </div>
      <div class="panel-body">
        <form id="entryForm" onsubmit="submitEntry(); return false;">
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="inputStrain" class="form-label">Name <span class="text-danger">*</span></label>
              <input type="text" id="inputStrain" class="form-control" required />
            </div>
            <div class="col-md-3">
              <label for="inputCompany" class="form-label">Company / Store</label>
              <input type="text" id="inputCompany" class="form-control" placeholder="Where you bought it" />
            </div>
            <div class="col-md-3">
              <label for="inputMethod" class="form-label">Product <span class="text-danger">*</span></label>
              <select id="inputMethod" class="form-select" required>
                <!-- Flower & Pre-rolls -->
                <option value="Flower">Flower</option>
                <option value="THCa Flower">THCa Flower</option>
                <option value="Pre-Roll">Pre-Roll</option>
                <option value="Infused Pre-Roll">Infused Pre-Roll</option>
                <option value="Kief">Kief</option>
                <!-- Hash & Rosin/Resin -->
                <option value="Hash">Hash</option>
                <option value="Water Hash / Bubble Hash">Water Hash / Bubble Hash</option>
                <option value="Dry Sift">Dry Sift</option>
                <option value="Hash Rosin">Hash Rosin</option>
                <option value="Flower Rosin">Flower Rosin</option>
                <option value="Live Rosin">Live Rosin</option>
                <option value="Live Resin">Live Resin</option>
                <option value="Resin">Resin</option>
                <option value="Distillate">Distillate</option>
                <option value="Shatter">Shatter</option>
                <option value="Wax">Wax</option>
                <option value="Budder">Budder</option>
                <option value="Crumble">Crumble</option>
                <option value="Diamonds">Diamonds</option>
                <option value="Sauce">Sauce</option>
                <option value="THCa Diamonds">THCa Diamonds</option>
                <!-- Vapes -->
                <option value="Vape Cartridge (510)">Vape Cartridge (510)</option>
                <option value="Disposable (All-in-One)">Disposable (All-in-One)</option>
                <option value="Pod System">Pod System</option>
                <!-- Edibles & Ingestibles -->
                <option value="Gummy Edibles">Gummy Edibles</option>
                <option value="Chocolate Edibles">Chocolate Edibles</option>
                <option value="Baked Edibles">Baked Edibles</option>
                <option value="Hard Candy / Lozenges">Hard Candy / Lozenges</option>
                <option value="Mints">Mints</option>
                <option value="Beverage / Drink">Beverage / Drink</option>
                <option value="Syrup">Syrup</option>
                <option value="Tincture">Tincture</option>
                <option value="RSO / FECO">RSO / FECO</option>
                <option value="Capsules / Softgels">Capsules / Softgels</option>
                <option value="Sublingual Strip">Sublingual Strip</option>
                <option value="Tea / Infusion">Tea / Infusion</option>
                <!-- Topicals & Patches -->
                <option value="Topical Cream / Lotion">Topical Cream / Lotion</option>
                <option value="Balm / Salve">Balm / Salve</option>
                <option value="Transdermal Patch">Transdermal Patch</option>
                <option value="Bath Soak / Salts">Bath Soak / Salts</option>
                <!-- Other / Devices -->
                <option value="Inhaler">Inhaler</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div class="row g-3 mb-3">
            <div class="col-md-3">
              <label for="inputDate" class="form-label">Date <span class="text-danger">*</span></label>
              <input type="date" id="inputDate" class="form-control" required />
            </div>
            <div class="col-md-9">
              <label for="onePuff" class="form-label d-flex justify-content-between align-items-center">
                <span>One Puff Rating</span>
                <span class="mono"><span id="ratingValue">5.0</span> / 10</span>
              </label>
              <input id="onePuff" type="range" class="slider" min="0" max="10" step="0.1" value="5.0" />
              <div class="form-text">Drag to set your rating (starts at 5.0).</div>
            </div>
          </div>

          <div class="mb-3">
            <label for="inputNotes" class="form-label">Notes</label>
            <textarea id="inputNotes" class="form-control" rows="3" placeholder="Effects, relief, side effects, contextâ€¦"></textarea>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" id="submitBtn" class="btn btn-success">Add Entry</button>
            <button type="button" id="cancelBtn" class="btn btn-outline-secondary d-none" onclick="cancelEdit()">Cancel</button>
          </div>
        </form>
      </div>
    </section>

    <!-- ENTRIES PANEL -->
    <section class="panel">
      <div class="panel-header">
        <h4 class="mb-0">Journal Entries</h4>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <div class="position-relative search-wrap">
            <span class="search-icon">ðŸ”Ž</span>
            <input id="searchInput" type="text" class="form-control" placeholder="Search entriesâ€¦" />
          </div>

          <!-- NEW: grouping controls (additive) -->
          <div class="group-controls">
            <select id="groupBy" class="form-select form-select-sm group-select" title="Group by">
              <option value="none">No Grouping</option>
              <option value="date">Group by Date</option>
              <option value="strain">Group by Name</option>
              <option value="company">Group by Company</option>
              <option value="method">Group by Product</option>
            </select>
            <button id="expandAll" class="group-btn" type="button">Expand All</button>
            <button id="collapseAll" class="group-btn" type="button">Collapse All</button>
          </div>

          <div class="d-flex gap-2 flex-wrap">
            <button id="exportBtn" type="button" class="btn btn-sm btn-outline-secondary">Export JSON</button>
            <label for="importFile" class="btn btn-sm btn-outline-secondary mb-0">Import JSON</label>
            <input id="importFile" type="file" accept="application/json" hidden />
          </div>
        </div>
      </div>
      <div class="panel-body">
        <div class="table-responsive">
          <table class="table align-middle" id="entriesTable">
            <thead class="table-light">
              <tr>
                <th class="sortable" data-sort="date">Date <span class="sort-indicator">â‡µ</span></th>
                <th class="sortable" data-sort="strain">Name <span class="sort-indicator">â‡µ</span></th>
                <th class="sortable" data-sort="company">Company <span class="sort-indicator">â‡µ</span></th>
                <th class="sortable" data-sort="method">Product <span class="sort-indicator">â‡µ</span></th>
                <th class="sortable" data-sort="rating">One Puff Rating <span class="sort-indicator">â‡µ</span></th>
                <th>Notes</th>
                <th style="width:140px">Actions</th>
              </tr>
            </thead>
            <tbody id="entriesTableBody"></tbody>
          </table>
        </div>
        <p id="noEntriesMsg" class="subtle mb-0"></p>
      </div>
    </section>

    <footer class="site-footer">
      Â© <span id="y"></span> Dear Mary J â€” <span class="mono">dearmaryj.com</span>
      Â· <a class="link-light" href="privacy.html" style="text-decoration:underline">Privacy</a>
      Â· <a class="link-light" href="terms.html" style="text-decoration:underline">Terms</a>
      <br />
      <span class="mono" style="font-size:12px;color:#8fb39e">
        We store only your purchase email and a Stripe customer ID to keep lifetime access. Your journal entries stay in your browser (localStorage).
      </span>
    </footer>
  </div>

  <script>
    const DMJ_API_BASE = "https://api.dearmaryj.com";
    document.getElementById('y').textContent = new Date().getFullYear();

    /* ---------- APP ---------- */
    let entries = [];
    let editingIndex = null;

    let sortKey = 'date';
    let sortDir = 'desc';
    let searchQuery = '';
    let groupBy = 'none'; // new

    function esc(str){ if(!str) return ""; return str.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;"); }

    try { const stored = localStorage.getItem('cannaEntries'); entries = stored ? JSON.parse(stored) : []; } catch(e){ entries = []; }

    (function(){
      const dateInput = document.getElementById('inputDate');
      const today = new Date(); const local = new Date(today.getTime() - today.getTimezoneOffset()*60000);
      dateInput.value = local.toISOString().split('T')[0];
    })();

    const slider = document.getElementById('onePuff');
    const ratingValue = document.getElementById('ratingValue');

    function setSliderFill(el){
      const min = parseFloat(el.min) || 0, max = parseFloat(el.max) || 10;
      const val = Math.min(max, Math.max(min, parseFloat(el.value)));
      const pct = ((val - min) / (max - min)) * 100;
      el.style.backgroundSize = Math.max(0, Math.min(100, pct)) + "% 100%";
    }
    function setRatingValue(v){
      const raw = parseFloat(v);
      const n = Number.isFinite(raw) ? Math.min(10, Math.max(0, raw)) : 5;
      ratingValue.textContent = n.toFixed(1);
      setSliderFill(slider);
    }
    setRatingValue(slider.value);
    slider.addEventListener('input', e => setRatingValue(e.target.value));

    function ratingLeafHtml(rating){
      const pct = Math.round((rating/10)*1000)/10;
      return `<div class="leaf-rating"><div class="leaf-rating-full" style="width:${pct}%"></div></div><span class="mono">${Number(rating).toFixed(1)}</span>`;
    }

    function filteredAndSortedEntries(){
      const q = searchQuery.trim().toLowerCase();
      let list = entries.slice();
      if(q){
        list = list.filter(e => (e.date||'').toLowerCase().includes(q)
          || (e.strain||'').toLowerCase().includes(q)
          || (e.company||'').toLowerCase().includes(q)
          || (e.method||'').toLowerCase().includes(q)
          || (e.notes||'').toLowerCase().includes(q));
      }
      list.sort((a,b) => {
        let va, vb;
        switch (sortKey){
          case 'date':   va = a.timestamp || Date.parse(a.date)||0; vb = b.timestamp || Date.parse(b.date)||0; break;
          case 'strain': va = (a.strain||'').toLowerCase(); vb = (b.strain||'').toLowerCase(); break;
          case 'company':va = (a.company||'').toLowerCase(); vb = (b.company||'').toLowerCase(); break;
          case 'method': va = (a.method||'').toLowerCase(); vb = (b.method||'').toLowerCase(); break;
          case 'rating': va = Number(a.rating)||0; vb = Number(b.rating)||0; break;
          default:       va = 0; vb = 0;
        }
        if(va < vb) return sortDir === 'asc' ? -1 : 1;
        if(va > vb) return sortDir === 'asc' ? 1 : -1;
        return 0;
      });
      return list;
    }

    // NEW: grouping helpers
    function groupKeyForEntry(e){
      switch (groupBy){
        case 'date':   return e.date || '(no date)';
        case 'strain': return (e.strain || '(no name)').toLowerCase();
        case 'company':return (e.company || '(no company)').toLowerCase();
        case 'method': return (e.method || '(no product)').toLowerCase();
        default:       return null;
      }
    }

    function buildGroups(list){
      if (groupBy === 'none') return null;
      const map = new Map();
      for (const item of list){
        const k = groupKeyForEntry(item);
        if (k == null) continue;
        if (!map.has(k)) map.set(k, []);
        map.get(k).push(item);
      }
      // sort groups by label asc
      const groups = Array.from(map.entries()).map(([k, items]) => ({ key: k, items }));
      groups.sort((a,b)=> a.key < b.key ? -1 : a.key > b.key ? 1 : 0);
      return groups;
    }

    function groupHeaderRowHtml(groupLabel, items){
      const count = items.length;
      const avg = (items.reduce((s, it)=> s + (Number(it.rating)||0), 0) / count) || 0;
      const niceLabel = groupLabel === groupLabel?.toLowerCase()
        ? groupLabel.replace(/\b\w/g, c=>c.toUpperCase())
        : groupLabel;
      const gid = 'g_' + btoa(unescape(encodeURIComponent(groupLabel))).replace(/=/g,'');
      return `
        <tr class="group-row" data-group-id="${gid}" onclick="toggleGroup('${gid}')">
          <td class="group-cell" colspan="7">
            <span class="collapse-indicator" id="${gid}_icon">â–¸</span>
            <span>${esc(niceLabel)}</span>
            <span class="group-meta">â€¢ ${count} item${count>1?'s':''} â€¢ avg ${avg.toFixed(1)}</span>
          </td>
        </tr>
      `;
    }

    // Global expanded state per group id
    const groupExpanded = {};

    function refreshEntriesTable(){
      const tbody = document.getElementById('entriesTableBody');
      const noMsg = document.getElementById('noEntriesMsg');
      const list = filteredAndSortedEntries();

      if(!list.length){ tbody.innerHTML = ""; noMsg.textContent = "No entries yet."; return; }
      noMsg.textContent = "";

      // If no grouping, render flat rows (original behavior)
      if (groupBy === 'none'){
        let html = "";
        list.forEach((e) => {
          const idx = entries.indexOf(e);
          const notesHtml = esc(e.notes).replace(/\n/g, "<br>");
          html += `<tr>
            <td data-label="Date">${esc(e.date)}</td>
            <td data-label="Name">${esc(e.strain)}</td>
            <td data-label="Company">${esc(e.company||'')}</td>
            <td data-label="Product">${esc(e.method)}</td>
            <td data-label="One Puff Rating">${ratingLeafHtml(e.rating)}</td>
            <td data-label="Notes">${notesHtml}</td>
            <td data-label="Actions">
              <button class="btn btn-sm btn-outline-secondary me-2" onclick="editEntry(${idx})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${idx})">Delete</button>
            </td>
          </tr>`;
        });
        tbody.innerHTML = html;
        return;
      }

      // Grouped rendering
      const groups = buildGroups(list);
      let html = "";
      groups.forEach(g => {
        const gid = 'g_' + btoa(unescape(encodeURIComponent(g.key))).replace(/=/g,'');
        const expanded = groupExpanded[gid] ?? false;
        html += groupHeaderRowHtml(g.key, g.items);
        g.items.forEach(e => {
          const idx = entries.indexOf(e);
          const notesHtml = esc(e.notes).replace(/\n/g, "<br>");
          html += `<tr class="group-item" data-parent="${gid}" style="${expanded ? '' : 'display:none'}">
            <td data-label="Date">${esc(e.date)}</td>
            <td data-label="Name">${esc(e.strain)}</td>
            <td data-label="Company">${esc(e.company||'')}</td>
            <td data-label="Product">${esc(e.method)}</td>
            <td data-label="One Puff Rating">${ratingLeafHtml(e.rating)}</td>
            <td data-label="Notes">${notesHtml}</td>
            <td data-label="Actions">
              <button class="btn btn-sm btn-outline-secondary me-2" onclick="editEntry(${idx})">Edit</button>
              <button class="btn btn-sm btn-outline-danger" onclick="deleteEntry(${idx})">Delete</button>
            </td>
          </tr>`;
        });
      });
      tbody.innerHTML = html;

      // Update arrows
      for (const gid in groupExpanded){
        const icon = document.getElementById(`${gid}_icon`);
        if (icon) icon.textContent = groupExpanded[gid] ? 'â–¾' : 'â–¸';
      }
    }
    refreshEntriesTable();

    // Sorting (unchanged)
    document.querySelectorAll('th.sortable').forEach(th => {
      th.addEventListener('click', () => {
        const key = th.getAttribute('data-sort');
        if(sortKey === key){ sortDir = (sortDir === 'asc') ? 'desc' : 'asc'; }
        else { sortKey = key; sortDir = (key === 'date' || key === 'rating') ? 'desc' : 'asc'; }
        refreshEntriesTable();
      });
    });

    // Search (unchanged)
    document.getElementById('searchInput').addEventListener('input', (e) => {
      searchQuery = e.target.value || '';
      refreshEntriesTable();
    });

    // Export / Import JSON (unchanged)
    function exportEntries(){
      try{
        const payload = { version: 1, exportedAt: new Date().toISOString(), entries };
        const data = JSON.stringify(payload, null, 2);
        const blob = new Blob([data], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const d = new Date();
        const pad = (n)=>String(n).padStart(2,'0');
        a.download = `dearmaryj-entries-${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}.json`;
        a.href = url; a.click();
        URL.revokeObjectURL(url);
      }catch(e){ alert('Export failed.'); }
    }
    function attachImportExport(){
      const exp = document.getElementById('exportBtn');
      const imp = document.getElementById('importFile');
      if(exp) exp.addEventListener('click', exportEntries);
      if(imp) imp.addEventListener('change', async (ev) => {
        const file = ev.target.files && ev.target.files[0];
        if(!file) return;
        try{
          const text = await file.text();
          const json = JSON.parse(text);
          const imported = Array.isArray(json) ? json : json.entries;
          if(!Array.isArray(imported)) throw new Error('Invalid file format');
          if(!confirm('Import will replace your current entries. Continue?')){ ev.target.value=''; return; }
          const norm = imported.map(e => ({
            strain: e.strain || e.name || '',
            company: e.company || '',
            method: e.method || e.product || 'Flower',
            date: e.date || '',
            rating: (typeof e.rating === 'number') ? e.rating : parseFloat(e.rating)||0,
            notes: e.notes || '',
            timestamp: e.timestamp || (Date.parse(e.date)||Date.now())
          }));
          entries = norm;
          localStorage.setItem('cannaEntries', JSON.stringify(entries));
          refreshEntriesTable();
          alert('Import complete.');
        }catch(err){
          alert('Import failed: ' + (err && err.message ? err.message : 'Unknown error'));
        }finally{
          ev.target.value='';
        }
      });
    }
    document.addEventListener('DOMContentLoaded', attachImportExport);

    // Form handlers (unchanged)
    function submitEntry(){
      const strain = document.getElementById('inputStrain').value.trim();
      const company = document.getElementById('inputCompany').value.trim();
      const method = document.getElementById('inputMethod').value;
      const date = document.getElementById('inputDate').value;
      const rating = parseFloat(slider.value.toString());
      const notes = document.getElementById('inputNotes').value.trim();
      let ts = Date.parse(date); if(isNaN(ts)) ts = Date.now();

      if(editingIndex === null){ entries.push({ strain, company, method, date, rating, notes, timestamp: ts }); }
      else { entries[editingIndex] = { strain, company, method, date, rating, notes, timestamp: ts }; }
      localStorage.setItem('cannaEntries', JSON.stringify(entries));
      refreshEntriesTable();

      document.getElementById('inputStrain').value = "";
      document.getElementById('inputCompany').value = "";
      document.getElementById('inputMethod').value = "Flower";
      const today = new Date(); const local = new Date(today.getTime() - today.getTimezoneOffset()*60000);
      document.getElementById('inputDate').value = local.toISOString().split('T')[0];
      slider.value = "5.0"; setRatingValue("5.0");
      document.getElementById('inputNotes').value = "";
      document.getElementById('submitBtn').textContent = "Add Entry";
      document.getElementById('cancelBtn').classList.add('d-none');
      editingIndex = null;
    }

    function editEntry(index){
      const e = entries[index];
      editingIndex = index;
      document.getElementById('inputStrain').value = e.strain || "";
      document.getElementById('inputCompany').value = e.company || "";
      document.getElementById('inputMethod').value = e.method || "Flower";
      document.getElementById('inputDate').value = e.date || "";

      // Preserve 0.0 ratings
      const r = (e.rating === 0 || typeof e.rating === 'number') ? Number(e.rating) : 5;
      slider.value = r.toFixed(1); setRatingValue(r);

      document.getElementById('inputNotes').value = e.notes || "";
      document.getElementById('submitBtn').textContent = "Update Entry";
      document.getElementById('cancelBtn').classList.remove('d-none');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteEntry(index){
      if(!confirm("Delete this entry?")) return;
      entries.splice(index,1);
      if(editingIndex !== null){
        if(index === editingIndex){ cancelEdit(); }
        else if(index < editingIndex){ editingIndex--; }
      }
      localStorage.setItem('cannaEntries', JSON.stringify(entries));
      refreshEntriesTable();
    }

    function cancelEdit(){
      document.getElementById('inputStrain').value = "";
      document.getElementById('inputCompany').value = "";
      document.getElementById('inputMethod').value = "Flower";
      const today = new Date(); const local = new Date(today.getTime() - today.getTimezoneOffset()*60000);
      document.getElementById('inputDate').value = local.toISOString().split('T')[0];
      slider.value = "5.0"; setRatingValue("5.0");
      document.getElementById('inputNotes').value = "";
      editingIndex = null;
      document.getElementById('submitBtn').textContent = "Add Entry";
      document.getElementById('cancelBtn').classList.add('d-none');
    }

    // --- Grouping interactions (new) ---
    document.getElementById('groupBy').addEventListener('change', (e) => {
      groupBy = e.target.value || 'none';
      // Reset expanded state on mode change
      for (const k in groupExpanded) delete groupExpanded[k];
      refreshEntriesTable();
    });

    window.toggleGroup = function(gid){
      groupExpanded[gid] = !groupExpanded[gid];
      const rows = document.querySelectorAll(`tr.group-item[data-parent="${gid}"]`);
      rows.forEach(r => r.style.display = groupExpanded[gid] ? '' : 'none');
      const icon = document.getElementById(`${gid}_icon`);
      if (icon) icon.textContent = groupExpanded[gid] ? 'â–¾' : 'â–¸';
    };

    document.getElementById('expandAll').addEventListener('click', () => {
      const groups = document.querySelectorAll('tr.group-row');
      groups.forEach(gr => {
        const gid = gr.getAttribute('data-group-id');
        groupExpanded[gid] = true;
      });
      document.querySelectorAll('tr.group-item').forEach(r => r.style.display = '');
      document.querySelectorAll('.collapse-indicator').forEach(i => i.textContent = 'â–¾');
    });

    document.getElementById('collapseAll').addEventListener('click', () => {
      const groups = document.querySelectorAll('tr.group-row');
      groups.forEach(gr => {
        const gid = gr.getAttribute('data-group-id');
        groupExpanded[gid] = false;
      });
      document.querySelectorAll('tr.group-item').forEach(r => r.style.display = 'none');
      document.querySelectorAll('.collapse-indicator').forEach(i => i.textContent = 'â–¸');
    });

    /* ---------- PAYWALL ---------- */
    async function dmjAuthStatus(){
      try {
        const r = await fetch(`${DMJ_API_BASE}/api/auth/status`, { credentials: 'include' });
        if (!r.ok) return { unlocked: false };
        return await r.json();
      } catch { return { unlocked: false }; }
    }
    async function dmjValidateSession(sessionId){
      try {
        const r = await fetch(`${DMJ_API_BASE}/api/validate-session`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ session_id: sessionId })
        });
        if (!r.ok) return false;
        const data = await r.json(); return !!data.unlocked;
      } catch { return false; }
    }

    (function initPaywall(){
      const params = new URLSearchParams(window.location.search);
      const sid = params.get('session_id');

      function showOverlay(on){
        const ov = document.getElementById('dmjPaywallOverlay');
        if (ov) ov.style.display = on ? 'block' : 'none';
      }

      document.addEventListener('DOMContentLoaded', () => {
        const unlock = document.getElementById('dmjUnlockBtn');
        if (unlock) unlock.addEventListener('click', (e) => {
          e.preventDefault();
          window.location.href = `${DMJ_API_BASE}/api/pay`;
        });

        const showRestore = document.getElementById('dmjShowRestore');
        const wrap = document.getElementById('dmjRestoreWrap');
        const restoreBtn = document.getElementById('dmjDoRestore');
        const emailInput = document.getElementById('dmjRestoreEmail');
        const msg = document.getElementById('dmjRestoreMsg');

        if (showRestore) showRestore.addEventListener('click', () => {
          wrap.style.display = wrap.style.display === 'none' ? 'block' : 'none';
          msg.textContent = '';
        });
        if (restoreBtn) restoreBtn.addEventListener('click', async () => {
          msg.textContent = 'Checkingâ€¦';
          const email = (emailInput.value || '').trim();
          if (!email) { msg.textContent = 'Please enter your email.'; return; }
          try {
            const r = await fetch(`${DMJ_API_BASE}/api/restore`, {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify({ email })
            });
            const data = await r.json();
            if (r.ok && data.unlocked) {
              msg.textContent = 'Restored â€” unlockingâ€¦';
              showOverlay(false);
            } else {
              msg.textContent = (data && data.error) ? data.error : 'Not found for that email.';
            }
          } catch {
            msg.textContent = 'Network error, try again.';
          }
        });
      });

      if (sid) {
        document.addEventListener('DOMContentLoaded', () => {
          const spin = document.getElementById('dmjPaywallSpinner');
          if (spin) spin.style.display = 'inline-block';
          showOverlay(true);
        });
        (async () => {
          const ok = await dmjValidateSession(sid);
          if (ok) {
            try { sessionStorage.setItem('dmj_just_unlocked', String(Date.now())); } catch {}
            const url = new URL(window.location.href);
            url.searchParams.delete('session_id');
            window.history.replaceState(null, '', url.toString());
            showOverlay(false);
          } else {
            showOverlay(true);
          }
        })();
      } else {
        document.addEventListener('DOMContentLoaded', async () => {
          let fresh = false;
          try {
            const ts = Number(sessionStorage.getItem('dmj_just_unlocked') || 0);
            fresh = ts && (Date.now() - ts < 5 * 60 * 1000);
          } catch {}
          if (fresh) showOverlay(false);

          const st = await dmjAuthStatus();

          if (st.unlocked) {
            showOverlay(false);
            try { sessionStorage.removeItem('dmj_just_unlocked'); } catch {}
          } else {
            showOverlay(!fresh);
          }
        });
      }
    })();
  </script>
</body>
</html>
